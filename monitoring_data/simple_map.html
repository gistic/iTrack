<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title></title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.15/esri/css/esri.css">
    
    <style>
      html, body, #map {
        height: 100%; width: 100%; margin: 0; padding: 0; 
      }
    </style>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
    <script src="https://js.arcgis.com/3.15/"></script>

    <!-- Beacons confiuration -->
    <script src="beacons.json"></script>

    <script>
         // Esri API
        var Map, Tiled, Point, SpatialReference, PictureMarkerSymbol, SimpleMarkerSymbol, Graphic, GraphicsLayer, Circle, SimpleFillSymbol, Color, CartographicLineSymbol, SimpleLineSymbol, Polyline, Polygon, FeatureLayer, FeatureSet, HeatmapRenderer, Event;
        var map;
        var visualize
        var run


        Parse.initialize("pey8pjhhotyDIusYHgSEF6SUI84ugMPVe6rqF2Ah", "I8CbFbjMrKNKKauFicygVWXbe0V1V7tixOqzQpcX");
        var regions = Object.keys(beacons)
        
 
        require(["esri/map", 
                "esri/layers/ArcGISTiledMapServiceLayer", 
                "esri/geometry/Point",
                "esri/SpatialReference",
                "esri/symbols/PictureMarkerSymbol",
                "esri/symbols/SimpleMarkerSymbol",
                "esri/graphic", 
                "esri/layers/GraphicsLayer",
                "esri/geometry/Circle",
                "esri/symbols/SimpleFillSymbol",
                "esri/Color",
                "esri/symbols/CartographicLineSymbol",
                "esri/symbols/SimpleLineSymbol",
                "esri/geometry/Polyline",
                "esri/geometry/Polygon",
                "esri/layers/FeatureLayer",
                "esri/tasks/FeatureSet", 
                "esri/renderers/HeatmapRenderer",
                "dojo/_base/event",
                
                "dojo/domReady!"],

            function(Map, Tiled, point, spatialReference, pictureMarkerSymbol, simpleMarkerSymbol, graphic, graphicsLayer, circle, simpleFillSymbol, color, cartographicLineSymbol, simpleLineSymbol, polyline, polygon, featureLayer, featureSet, heatmapRenderer, event) {
                
                Point = point;
                SpatialReference =  spatialReference;
                PictureMarkerSymbol = pictureMarkerSymbol
                SimpleMarkerSymbol = simpleMarkerSymbol
                Graphic = graphic;
                GraphicsLayer = graphicsLayer
                Circle = circle
                SimpleFillSymbol = simpleFillSymbol
                Color = color
                CartographicLineSymbol = cartographicLineSymbol
                SimpleLineSymbol = simpleLineSymbol
                Polyline = polyline;
                Polygon = polygon;
                FeatureLayer = featureLayer;
                FeatureSet = featureSet;
                HeatmapRenderer = heatmapRenderer;
                Event = event;

                map = new Map("map");
                var tiled = new Tiled("https://tiles1.arcgis.com/tiles/W83WxNh9tBPYYG7b/arcgis/rest/services/MTVC_FF/MapServer");
                map.addLayer(tiled);
                var sp = new SpatialReference({ wkid: 32637 })

                //add beacons graphics:
                gf = new GraphicsLayer();
                map.addLayer(gf)
                
                ff = new GraphicsLayer();
                map.addLayer(ff)

                regions.forEach(function (region){
                    p = new Point(beacons[region].x, beacons[region].y, sp);
                    floor = beacons[region].floor
                    var layer = floor == 0 ? gf : ff
                    var marker = new PictureMarkerSymbol("/img/active-" + floor + ".gif", 16, 16);
                    g = new Graphic(p, marker)
                    layer.add(g)
                    g.hide()
                    beacons[region].g = g
                })

              

                
                marker = new PictureMarkerSymbol("/img/current.png", 16, 16);
                marker2 = new PictureMarkerSymbol("/img/current2.png", 16, 16);
                gl = new GraphicsLayer();
                current_pos = new Graphic(null, marker)
                calculated_pos = new Graphic(null, marker2)
                gl.add(current_pos);
                gl.add(calculated_pos)
                map.addLayer(gl)

                visualize = function (data){
                   
                    x = data.get("X")
                    y = data.get("Y")
                    if (x && y){
                        var p = new Point(x, y, sp);
                        current_pos.setGeometry(p);    
                    }
                    
                    sumX = 0
                    sumY = 0
                    count = 0
                    regions.forEach(function (region){
                        if (data.get(region)){
                            beacons[region].g.show()
                            sumX += beacons[region].x
                            sumY += beacons[region].y
                            count ++;
                        }else{
                            beacons[region].g.hide()
                        }
                        
                    })
                    if (count != 0 ){
                        calculated_x = sumX/count
                        calculated_y = sumY/count
                        var p = new Point(calculated_x, calculated_y, sp);
                        calculated_pos.setGeometry(p);   
                    }
                    
                    
                }


                var Positions = Parse.Object.extend("Monitoring");
                run = function (){
                    var query = new Parse.Query(Positions);
                    var data = [];
                    query.descending("timeStamp");
                    query.equalTo("experiment_name", $("#experiment_name").val())
                    query._limit = 1000;
                    query.find({
                        success: function(results) {
                            console.log(`results:${results.length}`);
                            if (results.length<=0)
                                return;
                            sim_start = results[results.length-1].get("timeStamp");
                            sim_end = results[0].get("timeStamp");
                            
                            sim_length = sim_end - sim_start
                            
                            
                            $("#seekbar").prop("max", sim_length)
                            var sim_time = 0
                            timeLooper = function (){
                                sim_speed = $("#speed").val()
                                d = new Date(sim_time).toISOString().slice(11, -1);
                                $("#time").html(d);
                                $("#seekbar").prop("value", sim_time)
                                sim_time += (10 * sim_speed)
                                if(sim_time <= sim_length)
                                    setTimeout(timeLooper, 10)
                            }
                            timeLooper();

                            
                            loop = function (){
                                item = results.pop()
                                if (item){
                                    diff = item.get("timeStamp") - sim_start - sim_time
                                    
                                    setTimeout(function (){
                                        visualize(item);
                                        loop();
                                    }, diff/sim_speed)
                                }
                            }
                            loop();
                            
                        }
                    });
                }

                $(document).ready(function (){
                    run();
                });                
            });
    </script>
  </head>
  <body>
    <div id="time">
        00:00:00
    </div>
    <label>Speed</label>
    
    <select id="speed">
      <option value="1" >1x</option>
      <option value="2">2x</option>
      <option value="4">4x</option>
      <option value="5" selected>5x</option>
      <option value="10">10x</option>
    </select>
    <br>
    <label>Experimant Name</label>
    <input type="text" id="experiment_name" value="exp_1"></input>
    <button onclick="run()">Run</button>

    <progress id="seekbar" value="0" max="1" 
                style=" position: absolute;
                        width: 90%;
                        top: 90px;
                        left: 110px;"
    ></progress>

    <div style=" position: absolute;
                        width: 250px;
                        top: 10px;
                        right: 20px;">

                        <img src="img/active-0.gif" width="16" heigth="16"/>
                        Grand Floor Beacon
                        <br>
                        <img src="img/active-1.gif" width="16" heigth="16"/>
                        First Floor Beacon

                        <br>
                        <img src="img/current.png" width="16" heigth="16"/>
                        Reported Position (Navibees)

                        <br>
                        <img src="img/current2.png" width="16" heigth="16"/>
                        Calculated Positon (Centroid)

    </div>    

    <div id="map">

    </div>

  </body>
</html>

