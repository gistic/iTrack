XMin= 599435.5810000002;
YMin= 2358326.3035000004;
XMax= 599518.2827000003;
YMax= 2358386.9219000004;
[I,map] = imread('map_GF.png','png');
yImg = linspace(YMax, YMin, size(I, 1));
xImg = linspace(XMin, XMax, size(I, 2));
image(xImg, yImg, I, 'CDataMapping', 'scaled');
set(gca,'Ydir','normal');
hold on






beacons = [
%Minor  x       y           floor
1	599468.358	2358372.647	0
2	599471.1361	2358373.771	0
3	599466.1752	2358367.09	0
4	599475.4356	2358374.499	0
5	599478.5445	2358366.429	0
6	599470.144	2358361.402	0
7	599477.0231	2358357.962	0
8	599482.7117	2358356.838	0
9	599472.8559	2358352.075	0
10	599468.4903	2358353.597	0
11	599467.3658	2358348.437	0
12	599462.1403	2358351.017	0
13	599451.5569	2358347.18	0
14	599460.0236	2358344.204	0
15	599454.1366	2358341.227	0
16	599448.0512	2358346.056	0
17	599450.7632	2358339.971	0
18	599452.3507	2358336.134	0
19	599458.5023	2358330.512	0
20	599464.6538	2358356.044	0
21	599466.1752	2358362.857	0
22	599484.6299	2358366.76	0
23	599490.8476	2358363.188	0
24	599496.7346	2358359.748	0
25	599489.1278	2358359.087	0
26	599501.4971	2358365.437	0
27	599507.2518	2358362.328	0
28	599504.7383	2358357.764	0
30	599507.5164	2358351.083	0
31	599508.6409	2358358.624	1
32	599503.3492	2358363.717	1
33	599503.9445	2358368.215	1
34	599499.6451	2358364.643	1
35	599493.0305	2358363.254	1
36	599492.5013	2358359.153	1
37	599485.0929	2358362.791	1
38	599482.1825	2358356.044	1
39	599479.4044	2358363.452	1
40	599477.5523	2358354.523	1
41	599470.2762	2358354.126	1
42	599469.2179	2358349.892	1
43	599463.9924	2358346.254	1
44	599461.9419	2358351.149	1
45	599459.0976	2358343.675	1
46	599452.0861	2358347.114	1
47	599448.3158	2358345.527	1
48	599454.2028	2358341.426	1
49	599451.9538	2358337.457	1
50	599493.7581	2358356.242	1
51	599498.3221	2358354.39	1
52	599488.7971	2358358.822	1
53	599456.7163	2358349.099	1
54	599449.7048	2358342.352	1
55	599506.3258	2358364.246	1
56	599479.6028	2358360.211	1
57	599462.8679	2358359.417	1
58	599459.3622	2358357.698	1
71	599509.3685	2358356.904	0
72	599458.7007	2358349.694	0
75	599476.3613	2358371.568	1
76	599485.6218	2358374.876	1
77	599486.4155	2358375.405	1
78	599495.5437	2358378.712	1
79	599496.7343	2358379.374	1
80	599505.4656	2358382.946	1
90	599456.5175	2358363.896	1
91	599448.0509	2358359.662	1
92	599437.4675	2358355.561	1
93	599446.5956	2358359.133	1
94	599457.3113	2358330.161	1
95	599457.7082	2358333.733	1
96	599467.1009	2358337.173	1
97	599468.953	2358337.569	1
98	599476.0967	2358342.067	1
99	599477.6842	2358341.538	1
100	599486.0186	2358346.565	1
101	599487.6061	2358344.845	1
102	599495.8082	2358349.476	1
103	599499.777	2358347.888	1
104	599507.7145	2358350.402	1
];


data = {
%id  timestamp  event(1:in, 0:out) triggered_by  covered_by

'xLOIluqEBv'	42547.34651	1	30	[30]
'7Nk1cEvfaH'	42547.34654	1	28	[28 30]
'5Cc14duclT'	42547.34661	1	71	[28 30 71]
'MKnQ4AY506'	42547.34668	1	27	[27 28 30 71]
'S54vQMwB7O'	42547.34675	1	26	[26 27 28 30 71]
'qxZsHcLnIi'	42547.34675	1	23	[23 26 27 28 30 71]
'Ms6ZFmNh0D'	42547.34676	1	22	[22 23 26 27 28 30 71]
'7MrQUNauhm'	42547.34682	1	4	[22 23 26 27 28 30 4 71]
'pvasktmdOs'	42547.34683	1	90	[22 23 26 27 28 30 4 71 90]
'80ZJ7aaEuC'	42547.34683	1	25	[22 23 25 26 27 28 30 4 71 90]
'W8DoVHSAks'	42547.34689	1	8	[22 23 25 26 27 28 30 4 71 8 90]
'Ttwr7MgvsD'	42547.34689	1	75	[22 23 25 26 27 28 30 4 71 75 8 90]
'1DHTF2uROC'	42547.34691	1	91	[22 23 25 26 27 28 30 4 71 75 8 90 91]
'tpdEVLJfVR'	42547.34692	0	30	[22 23 25 26 27 28 4 71 75 8 90 91]
'cA6GlGks7A'	42547.34692	0	71	[22 23 25 26 27 28 4 75 8 90 91]
'HzO8LI6UW7'	42547.34693	0	22	[23 25 26 27 28 4 75 8 90 91]
'T9brgqWFvl'	42547.34694	0	23	[25 26 27 28 4 75 8 90 91]
'zkeK9KjiLA'	42547.34694	0	26	[25 27 28 4 75 8 90 91]
'5regEc4dUj'	42547.34696	1	84	[25 27 28 4 75 8 84 90 91]
'Lzv6f59nXC'	42547.34696	1	22	[22 25 27 28 4 75 8 84 90 91]
'Js1d3lALfJ'	42547.34697	1	85	[22 25 27 28 4 75 8 84 85 90 91]
'6juzzhiO62'	42547.34697	0	28	[22 25 27 4 75 8 84 85 90 91]
'MS4sFf6wkN'	42547.34698	0	90	[22 25 27 4 75 8 84 85 91]
'fVLei1NbR1'	42547.34699	0	4	[22 25 27 75 8 84 85 91]
'ffjGEpqeXB'	42547.34699	0	27	[22 25 75 8 84 85 91]
'hh372aqXul'	42547.34703	1	90	[22 25 75 8 84 85 90 91]
'VXnU7111Cd'	42547.34704	0	91	[22 25 75 8 84 85 90]
'NBUgUW6iGT'	42547.34705	0	75	[22 25 8 84 85 90]
'o0xG4Mbab1'	42547.3471	1	23	[22 23 25 8 84 85 90]
'ZaZjXGPHq3'	42547.34711	1	4	[22 23 25 4 8 84 85 90]
'wIaIFuOV0K'	42547.34711	1	75	[22 23 25 4 75 8 84 85 90]
'xpVIkGtf8P'	42547.34711	1	81	[22 23 25 4 75 8 81 84 85 90]
'LUy0KWGl0X'	42547.34712	0	22	[23 25 4 75 8 81 84 85 90]
'ovSS4tdfX9'	42547.34712	0	85	[23 25 4 75 8 81 84 90]
'SLioMC5vW1'	42547.34718	1	86	[23 25 4 75 8 81 84 86 90]
'JEnu4Ij51F'	42547.34718	1	6	[23 25 4 6 75 8 81 84 86 90]
'tHjyDsmxcx'	42547.34719	0	84	[23 25 4 6 75 8 81 86 90]
'Hj0X0XCypn'	42547.34724	1	61	[23 25 4 6 61 75 8 81 86 90]
'vVYdJWkBed'	42547.34725	0	81	[23 25 4 6 61 75 8 86 90]
'cU7EWY15nR'	42547.34726	0	23	[25 4 6 61 75 8 86 90]
'ttsZJwpQxp'	42547.34726	0	25	[4 6 61 75 8 86 90]
'pooK3qRyDR'	42547.34727	0	8	[4 6 61 75 86 90]
'3QIdL78m7i'	42547.34728	0	75	[4 6 61 86 90]
'NrYr9BJIg9'	42547.34732	1	80	[4 6 61 80 86 90]
'o3vEBfBZ3O'	42547.34733	0	90	[4 6 61 80 86]
'eu2fFcWNAw'	42547.34733	0	6	[4 61 80 86]
'xpio5wTbV5'	42547.34733	0	4	[61 80 86]
'wxTcx7oYId'	42547.34734	0	86	[61 80]
'o8fd6tr38X'	42547.34738	1	62	[61 62 80]
'rw6tf4wwF6'	42547.34739	0	61	[62 80]
'DeqBE0dqk8'	42547.34747	0	80	[62]
'IXDMIaqDGR'	42547.34753	1	90	[62 90]
'hlHMfguqN8'	42547.34753	1	23	[23 62 90]
'3Glcdh6sx0'	42547.34754	0	62	[23 90]
'5i7FMILoYy'	42547.34767	1	10	[10 23 90]
'llwkXl0PFg'	42547.34767	1	20	[10 20 23 90]
'AMZtiJBSZi'	42547.34768	1	21	[10 20 21 23 90]
'3JiyeVa1fp'	42547.34769	0	23	[10 20 21 90]
'LU7E5NwDgJ'	42547.34774	1	15	[10 15 20 21 90]
'KYkOwPdTbx'	42547.34775	1	9	[10 15 20 21 9 90]
'AmtYjf5WD4'	42547.34776	1	72	[10 15 20 21 72 9 90]
'aNyyZLf1QC'	42547.34776	1	11	[10 11 15 20 21 72 9 90]
'cM6MLCgcmi'	42547.34777	0	90	[10 11 15 20 21 72 9]
'N8U3QwtJ4n'	42547.3478	1	75	[10 11 15 20 21 72 75 9]
'DfS24ExGS1'	42547.34781	1	23	[10 11 15 20 21 23 72 75 9]
'JyeJDoAWB4'	42547.34782	1	14	[10 11 14 15 20 21 23 72 75 9]
'Rc2jRvHZOU'	42547.34782	1	16	[10 11 14 15 16 20 21 23 72 75 9]
'8lIF6hC1PB'	42547.34783	0	21	[10 11 14 15 16 20 23 72 75 9]
'yrwYueXFMS'	42547.34788	1	12	[10 11 12 14 15 16 20 23 72 75 9]
'5fkxjJ289c'	42547.34788	1	13	[10 11 12 13 14 15 16 20 23 72 75 9]
'abXClrTd41'	42547.34789	0	15	[10 11 12 13 14 16 20 23 72 75 9]
'EVdH6X4woT'	42547.34789	0	10	[11 12 13 14 16 20 23 72 75 9]
'GDya02h96A'	42547.34795	1	17	[11 12 13 14 16 17 20 23 72 75 9]
'iheqbmI9Xj'	42547.34795	1	15	[11 12 13 14 15 16 17 20 23 72 75 9]
'0YcBRKkGiU'	42547.34796	0	20	[11 12 13 14 15 16 17 23 72 75 9]
'FZukzMAYRT'	42547.34797	0	23	[11 12 13 14 15 16 17 72 75 9]
'W50nhsUMIv'	42547.34798	0	16	[11 12 13 14 15 17 72 75 9]
'9rkJ39r5eO'	42547.34798	0	75	[11 12 13 14 15 17 72 9]
'MsFq8OXsCO'	42547.34802	1	10	[10 11 12 13 14 15 17 72 9]
'usksh3qJSN'	42547.34802	1	20	[10 11 12 13 14 15 17 20 72 9]
'KLv2PpozLA'	42547.34803	1	18	[10 11 12 13 14 15 17 18 20 72 9]
's53BQdL3MY'	42547.34803	1	16	[10 11 12 13 14 15 16 17 18 20 72 9]
'c8EuRqBx0i'	42547.34804	0	14	[10 11 12 13 15 16 17 18 20 72 9]
'c00zoA5npK'	42547.34809	1	14	[10 11 12 13 14 15 16 17 18 20 72 9]
'EoG4QG2kVS'	42547.34811	0	72	[10 11 12 13 14 15 16 17 18 20 9]
'Up9qBzFit1'	42547.34816	1	19	[10 11 12 13 14 15 16 17 18 19 20 9]
'teUaMKS6nS'	42547.34817	0	20	[10 11 12 13 14 15 16 17 18 19 9]
'Fo0aLOm8Aj'	42547.34818	0	10	[11 12 13 14 15 16 17 18 19 9]
'JdDIkDjMOJ'	42547.34818	0	9	[11 12 13 14 15 16 17 18 19]
'HMFxDIoCTn'	42547.34824	0	17	[11 12 13 14 15 16 18 19]
'rTDQ95ef1l'	42547.34825	0	11	[12 13 14 15 16 18 19]
'UJyqIAKmEI'	42547.34831	0	15	[12 13 14 16 18 19]
'TskIL14rA4'	42547.34832	0	12	[13 14 16 18 19]
'qkUT6hlpx2'	42547.34838	0	14	[13 16 18 19]
'wUgt7dyDrT'	42547.34839	0	13	[16 18 19]
'CKzvIiySwk'	42547.34839	0	18	[16 19]
'ytPrm6ozoH'	42547.3484	0	19	[16]
'JODJfHu7vB'	42547.3484	0	16	[]
};


in_timestamps = cell2mat(data(find(cell2mat(data(:,3))==[1]),[2 4]));
%uniformaly sampling data
p = 1/86400;  % 1 second in a day
tstamps = cell2mat(data(:,2));
sampled = {};
for t = min(tstamps)+p:p:max(tstamps) + p
    tags = data(max(find (cell2mat(data(:,2))<t)),5);
    sampled(end+1,1:2) = [t tags];
end


trajectory = [];

 for n=1:length(sampled)
     t=cell2mat(sampled(n));
     coverage = cell2mat(sampled(n,2));
      gf = beacons(find(beacons(:,4)==0),:)
      coverage = transpose(intersect(coverage, gf));
%       coverage = transpose(intersect (coverage,in_timestamps(:,2)))

     if size(coverage) > 0
            if numel(coverage) > 1
%     %           % Hierarchical filtering
                  X = beacons(ismember(beacons(:,1),transpose(coverage)), 1:3);
                  Y = pdist(X(:,2:3));
                  Z = linkage(Y);
                  T = cluster(Z,'maxclust',2);
                  if size(T(T==1)) >= size(T(T==2))
                      culster_id = 1;
                  else
                      culster_id = 2;
                  end
                  original_coverage = coverage;
                  coverage = transpose (intersect(X(T==culster_id), coverage))
%     %           % end filtering
            end
         
         
         last_in = [];
         for tag = coverage
             appeared_on = in_timestamps(max(find(in_timestamps(:,2)==tag & in_timestamps(:,1) <= t)));

             if isempty(appeared_on)
                 appeared_on = min(cell2mat(sampled(:,1)));
             end
             last_in(end+1,1) = appeared_on;
         end
    %      last_in= (last_in*1000) - min(last_in)
         if size(coverage) <=3
             last_in(:,1) = 1;
         else
                if range(last_in) == 0
                    last_in(:,1) = 1;
                else
                    last_in = last_in - min(last_in);
                    last_in = last_in/sum(last_in) * 100;
                end

         end
     
     
%          avg_x = mean (beacons(ismember(beacons(:,1),transpose(coverage)), 2));
%          avg_y = mean (beacons(ismember(beacons(:,1),transpose(coverage)), 3));
%          x(end+1) = avg_x;
%          y(end+1) = avg_y;

         wavg_x = sum (beacons(ismember(beacons(:,1),transpose(coverage)), 2) .* last_in)/sum(last_in);
          wavg_y = sum (beacons(ismember(beacons(:,1),transpose(coverage)), 3) .* last_in)/sum(last_in);
          trajectory(end+1,:) = [t, wavg_x, wavg_y];
          
     end
 end


% x=[];
% y=[];
% lookAhead = 2;
% for n=1:length(data)-lookAhead
%     coverage = cell2mat(data(n,5));
%     for l=1:lookAhead
%         coverage = intersect(coverage, cell2mat(data(n+l,5)));
%     end
%     if size(coverage)< 4
%         coverage = cell2mat(data(n,5));
%     end
%     if size(coverage) > 0
%         avg_x = mean(beacons(ismember(beacons(:,1),transpose(coverage)), 2));
%         avg_y = mean(beacons(ismember(beacons(:,1),transpose(coverage)), 3));
%         x(end+1) = avg_x;
%         y(end+1) = avg_y;
%     end
% end

x = trajectory(:,2);
y = trajectory(:,3);

Y= dct(y);Y1=Y;Y1(10:end)=0;y1 = idct(Y1);
X= dct(x);X1=X;X1(10:end)=0;x1 = idct(X1);
plot(x, y,'r','LineWidth',2);


        
legend('Ground Truth', 'Estimated Trajectory')