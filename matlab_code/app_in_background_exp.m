XMin= 599435.5810000002;
YMin= 2358326.3035000004;
XMax= 599518.2827000003;
YMax= 2358386.9219000004;
[I,map] = imread('map_FF.png','png');
yImg = linspace(YMax, YMin, size(I, 1));
xImg = linspace(XMin, XMax, size(I, 2));
image(xImg, yImg, I, 'CDataMapping', 'scaled');
set(gca,'Ydir','normal');
hold on






beacons = [
%Minor  x       y           floor
1	599468.358	2358372.647	0
2	599471.1361	2358373.771	0
3	599466.1752	2358367.09	0
4	599475.4356	2358374.499	0
5	599478.5445	2358366.429	0
6	599470.144	2358361.402	0
7	599477.0231	2358357.962	0
8	599482.7117	2358356.838	0
9	599472.8559	2358352.075	0
10	599468.4903	2358353.597	0
11	599467.3658	2358348.437	0
12	599462.1403	2358351.017	0
13	599451.5569	2358347.18	0
14	599460.0236	2358344.204	0
15	599454.1366	2358341.227	0
16	599448.0512	2358346.056	0
17	599450.7632	2358339.971	0
18	599452.3507	2358336.134	0
19	599458.5023	2358330.512	0
20	599464.6538	2358356.044	0
21	599466.1752	2358362.857	0
22	599484.6299	2358366.76	0
23	599490.8476	2358363.188	0
24	599496.7346	2358359.748	0
25	599489.1278	2358359.087	0
26	599501.4971	2358365.437	0
27	599507.2518	2358362.328	0
28	599504.7383	2358357.764	0
30	599507.5164	2358351.083	0
31	599508.6409	2358358.624	1
32	599503.3492	2358363.717	1
33	599503.9445	2358368.215	1
34	599499.6451	2358364.643	1
35	599493.0305	2358363.254	1
36	599492.5013	2358359.153	1
37	599485.0929	2358362.791	1
38	599482.1825	2358356.044	1
39	599479.4044	2358363.452	1
40	599477.5523	2358354.523	1
41	599470.2762	2358354.126	1
42	599469.2179	2358349.892	1
43	599463.9924	2358346.254	1
44	599461.9419	2358351.149	1
45	599459.0976	2358343.675	1
46	599452.0861	2358347.114	1
47	599448.3158	2358345.527	1
48	599454.2028	2358341.426	1
49	599451.9538	2358337.457	1
50	599493.7581	2358356.242	1
51	599498.3221	2358354.39	1
52	599488.7971	2358358.822	1
53	599456.7163	2358349.099	1
54	599449.7048	2358342.352	1
55	599506.3258	2358364.246	1
56	599479.6028	2358360.211	1
57	599462.8679	2358359.417	1
58	599459.3622	2358357.698	1
71	599509.3685	2358356.904	0
72	599458.7007	2358349.694	0
75	599476.3613	2358371.568	1
76	599485.6218	2358374.876	1
77	599486.4155	2358375.405	1
78	599495.5437	2358378.712	1
79	599496.7343	2358379.374	1
80	599505.4656	2358382.946	1
90	599456.5175	2358363.896	1
91	599448.0509	2358359.662	1
92	599437.4675	2358355.561	1
93	599446.5956	2358359.133	1
94	599457.3113	2358330.161	1
95	599457.7082	2358333.733	1
96	599467.1009	2358337.173	1
97	599468.953	2358337.569	1
98	599476.0967	2358342.067	1
99	599477.6842	2358341.538	1
100	599486.0186	2358346.565	1
101	599487.6061	2358344.845	1
102	599495.8082	2358349.476	1
103	599499.777	2358347.888	1
104	599507.7145	2358350.402	1
];


data = {
%id  timestamp  event(1:in, 0:out) triggered_by  covered_by

'gx06ovR34b'	42544.4053	1	91	[91]
'It0jrP1IPn'	42544.4053	1	94	[91 94]
'ClaPG8EmIp'	42544.4053	1	89	[89 91 94]
'RMEJ4aM2xA'	42544.40531	1	99	[89 91 94 99]
'iHJSa3fS7I'	42544.40531	1	82	[82 89 91 94 99]
'dslejLqErx'	42544.40531	1	85	[82 85 89 91 94 99]
'mtWV4DGbnm'	42544.40531	1	81	[81 82 85 89 91 94 99]
'Si0RpRr9wD'	42544.40532	1	84	[81 82 84 85 89 91 94 99]
'dlPEXEl8Cx'	42544.40534	1	100	[100 81 82 84 85 89 91 94 99]
'9V3nHN2JIb'	42544.40534	1	96	[100 81 82 84 85 89 91 94 96 99]
'FaelbW8Hf9'	42544.40535	1	102	[100 102 81 82 84 85 89 91 94 96 99]
'qLS6g4ie4g'	42544.40535	1	95	[100 102 81 82 84 85 89 91 94 95 96 99]
'gHaYNOOZsg'	42544.40536	1	87	[100 102 81 82 84 85 87 89 91 94 95 96 99]
'54WZeqiBg5'	42544.40536	1	97	[100 102 81 82 84 85 87 89 91 94 95 96 97 99]
'6BO5AxpHuT'	42544.40537	1	48	[100 102 48 81 82 84 85 87 89 91 94 95 96 97 99]
'H0mr0fszkK'	42544.40537	1	104	[100 102 104 48 81 82 84 85 87 89 91 94 95 96 97 99]
'62M5rqBzFA'	42544.40538	1	98	[100 102 104 48 81 82 84 85 87 89 91 94 95 96 97 98 99]
'tKtCgEIsF7'	42544.40538	1	101	[100 101 102 104 48 81 82 84 85 87 89 91 94 95 96 97 98 99]
'vkm3W6GRrq'	42544.40539	1	42	[100 101 102 104 42 48 81 82 84 85 87 89 91 94 95 96 97 98 99]
'3Biu7c1EFn'	42544.40539	1	45	[100 101 102 104 42 45 48 81 82 84 85 87 89 91 94 95 96 97 98 99]
'MAsJHYxBUT'	42544.40541	1	90	[100 101 102 104 42 45 48 81 82 84 85 87 89 90 91 94 95 96 97 98 99]
'ouAApjhLK0'	42544.40541	1	88	[100 101 102 104 42 45 48 81 82 84 85 87 88 89 90 91 94 95 96 97 98 99]
'QGGrvBRpKM'	42544.40542	1	83	[100 101 102 104 42 45 48 81 82 83 84 85 87 88 89 90 91 94 95 96 97 98 99]
'IUZPp6rx3R'	42544.40542	1	86	[100 101 102 104 42 45 48 81 82 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'HWU3vuZxvT'	42544.40547	1	43	[100 101 102 104 42 43 45 48 81 82 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'LyX6LUS4Fg'	42544.40547	1	44	[100 101 102 104 42 43 44 45 48 81 82 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'bVvPwV3Y2i'	42544.4055	0	94	[100 101 102 104 42 43 44 45 48 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'Ai8tSDLMMq'	42544.4055	0	42	[100 101 102 104 43 44 45 48 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'tpwaBgUTBo'	42544.40551	0	81	[100 101 102 104 43 44 45 48 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'rMNHpHndBL'	42544.40551	0	100	[101 102 104 43 44 45 48 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'XVy5DbPho0'	42544.40551	0	104	[101 102 43 44 45 48 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'D0HU7QPZew'	42544.40552	0	102	[101 43 44 45 48 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'C4kkYnuTtD'	42544.40554	1	100	[100 101 43 44 45 48 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'fpDyNog8YM'	42544.40556	1	46	[100 101 43 44 45 46 48 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'CGUPK0fDLg'	42544.40556	1	94	[100 101 43 44 45 46 48 82 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'ctzX4WymeP'	42544.40556	1	81	[100 101 43 44 45 46 48 81 82 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'YIsO8801jZ'	42544.40557	0	82	[100 101 43 44 45 46 48 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'revBEdJoz3'	42544.40563	0	90	[100 101 43 44 45 46 48 81 83 84 85 86 87 88 89 91 94 95 96 97 98 99]
'hNaMEjQUrR'	42544.40564	0	85	[100 101 43 44 45 46 48 81 83 84 86 87 88 89 91 94 95 96 97 98 99]
'ReuzjTtOEM'	42544.40565	0	44	[100 101 43 45 46 48 81 83 84 86 87 88 89 91 94 95 96 97 98 99]
'nf2i01koio'	42544.40568	1	85	[100 101 43 45 46 48 81 83 84 85 86 87 88 89 91 94 95 96 97 98 99]
'9PPwWEtxgB'	42544.40569	1	90	[100 101 43 45 46 48 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'AflAeKXGgE'	42544.40569	1	42	[100 101 42 43 45 46 48 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'7GlxLxrBqd'	42544.40571	0	48	[100 101 42 43 45 46 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'uyV53lSJIG'	42544.40571	0	83	[100 101 42 43 45 46 81 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'Kb2OgXFwNe'	42544.40571	0	43	[100 101 42 45 46 81 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'zBbDaF9dAY'	42544.40572	0	45	[100 101 42 46 81 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'uto5A6W9XI'	42544.40575	1	48	[100 101 42 46 48 81 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'3b4DxukrbY'	42544.40575	1	41	[100 101 41 42 46 48 81 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'CcA4ebrefy'	42544.40576	1	83	[100 101 41 42 46 48 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'iBCDXgsNXb'	42544.40576	1	44	[100 101 41 42 44 46 48 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'cRd6uZKrlM'	42544.40578	1	54	[100 101 41 42 44 46 48 54 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'OyXxN2HRU5'	42544.40583	1	49	[100 101 41 42 44 46 48 49 54 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'yrSDZI2cCJ'	42544.40583	0	101	[100 41 42 44 46 48 49 54 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'JZRy5sA91d'	42544.40586	0	42	[100 41 44 46 48 49 54 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'laoioF1er1'	42544.4059	1	76	[100 41 44 46 48 49 54 76 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'VdR9IPsqqA'	42544.40591	0	54	[100 41 44 46 48 49 76 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'mJMLSEpYl7'	42544.40591	0	41	[100 44 46 48 49 76 81 83 84 85 86 87 88 89 90 91 94 95 96 97 98 99]
'IJuVGVtLgX'	42544.40594	0	94	[100 44 46 48 49 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'E0eE11YXrh'	42544.40594	0	48	[100 44 46 49 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'lrZAtS8jlY'	42544.40595	0	46	[100 44 49 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'qNrKARYn4M'	42544.40595	0	100	[44 49 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'SAetXuTcJW'	42544.40597	1	43	[43 44 49 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'fbmfzvewbo'	42544.40597	1	101	[101 43 44 49 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'uK5e1lqDYk'	42544.40598	1	58	[101 43 44 49 58 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'spkrPmi54Y'	42544.40598	1	75	[101 43 44 49 58 75 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'rRdrkcElaU'	42544.406	0	49	[101 43 44 58 75 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'j2NukedjWG'	42544.406	0	91	[101 43 44 58 75 76 81 83 84 85 86 87 88 89 90 95 96 97 98 99]
't6R0uSUcLC'	42544.406	0	45	[101 43 44 58 75 76 81 83 84 85 86 87 88 89 90 95 96 97 98 99]
'xevCIRYDy6'	42544.40604	1	41	[101 41 43 44 58 75 76 81 83 84 85 86 87 88 89 90 95 96 97 98 99]
'0iU4dstDHu'	42544.40604	1	91	[101 41 43 44 58 75 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'JkuxnePC6I'	42544.40605	0	96	[101 41 43 44 58 75 76 81 83 84 85 86 87 88 89 90 91 95 97 98 99]
'tBTi9QnrcE'	42544.40605	0	76	[101 41 43 44 58 75 81 83 84 85 86 87 88 89 90 91 95 97 98 99]
'ZBzDHhc81O'	42544.40605	0	44	[101 41 43 58 75 81 83 84 85 86 87 88 89 90 91 95 97 98 99]
'JncqAIZeFB'	42544.40612	1	100	[100 101 41 43 58 75 81 83 84 85 86 87 88 89 90 91 95 97 98 99]
'xYfFXFcbEp'	42544.40612	0	95	[100 101 41 43 58 75 81 83 84 85 86 87 88 89 90 91 97 98 99]
'QUVIElrucl'	42544.40613	0	97	[100 101 41 43 58 75 81 83 84 85 86 87 88 89 90 91 98 99]
'1SjyevbuGP'	42544.40615	0	98	[100 101 41 43 58 75 81 83 84 85 86 87 88 89 90 91 99]
'PR9yeLllZx'	42544.40615	0	90	[100 101 41 43 58 75 81 83 84 85 86 87 88 89 91 99]
'pllml9uhZ6'	42544.40615	0	99	[100 101 41 43 58 75 81 83 84 85 86 87 88 89 91]
'vUa3xJgDzF'	42544.40616	0	85	[100 101 41 43 58 75 81 83 84 86 87 88 89 91]
'VC8GaRGySX'	42544.40616	0	81	[100 101 41 43 58 75 83 84 86 87 88 89 91]
'7HoLVKci9Y'	42544.40617	0	58	[100 101 41 43 75 83 84 86 87 88 89 91]
'04plfn2yuQ'	42544.40617	0	84	[100 101 41 43 75 83 86 87 88 89 91]
'wMdZgLPA9T'	42544.40617	0	87	[100 101 41 43 75 83 86 88 89 91]
'fCy9tTtVLh'	42544.40618	0	86	[100 101 41 43 75 83 88 89 91]
'RvQzjpus9A'	42544.40618	0	43	[100 101 41 75 83 88 89 91]
'OxJ202ZwIK'	42544.40619	1	77	[100 101 41 75 77 83 88 89 91]
'8phzwijDUx'	42544.40619	0	88	[100 101 41 75 77 83 89 91]
'T5IR7fs9fd'	42544.40619	0	89	[100 101 41 75 77 83 91]
'EkvmifZQwN'	42544.4062	0	91	[100 101 41 75 77 83]
'4Yna3tix0a'	42544.4062	0	83	[100 101 41 75 77]
'x042kkQOyo'	42544.40626	0	41	[100 101 75 77]
'J06QHM9yZ6'	42544.40627	0	101	[100 75 77]
'UCWqkgxOJf'	42544.40627	0	100	[75 77]
'NJpEIcPT51'	42544.40627	0	75	[77]
'p01S4Ms9GV'	42544.40633	1	75	[75 77]
'thqS0L85CC'	42544.40633	0	77	[75]
'UOF8IsmJTf'	42544.4064	1	99	[75 99]
'D6azcqzQbf'	42544.40647	0	75	[99]
'yvidfbZP1R'	42544.40654	0	99	[]
'QVsbDQ2O7b'	42544.40661	1	79	[79]
'Wn6I17l4XC'	42544.40661	1	76	[76 79]
'UiWiX1wWcx'	42544.40676	0	76	[79]
'6bNY05SUdp'	42544.40676	0	79	[]
'2MnjLufcC6'	42544.40696	1	89	[89]
'w9bE1twXUK'	42544.40711	0	89	[]
'7RjHD1pNUf'	42544.40737	1	77	[77]
'YeVHV7JNMU'	42544.40738	1	103	[103 77]
'WMvfw9KsFc'	42544.40745	1	76	[103 76 77]
'gPzKUoVrl8'	42544.40753	0	103	[76 77]
'IwILD65ImQ'	42544.40753	0	77	[76]
'gHUn1ypITs'	42544.40759	1	77	[76 77]
'JbsP2oA7KQ'	42544.40759	1	61	[61 76 77]
'CUC8fwDksi'	42544.4076	1	62	[61 62 76 77]
'N7uS8vxMYG'	42544.4076	0	76	[61 62 77]
'YLLjLbw9Bl'	42544.40767	1	75	[61 62 75 77]
'kQiE5sgN4U'	42544.40767	1	87	[61 62 75 77 87]
'3ackumIS0D'	42544.40767	1	63	[61 62 63 75 77 87]
'NRShwvp5Bh'	42544.40774	1	76	[61 62 63 75 76 77 87]
'QSxAjO6FyR'	42544.40774	0	62	[61 63 75 76 77 87]
'1kAAYHQQsz'	42544.40774	0	61	[63 75 76 77 87]
'CxqCYa46UW'	42544.40781	0	63	[75 76 77 87]
'2Z9eZjjbM7'	42544.40782	0	87	[75 76 77]
'X4uRNaEiia'	42544.40782	0	75	[76 77]
'HAO4bVFcXD'	42544.40788	1	75	[75 76 77]
'7JHLmJctad'	42544.40788	0	76	[75 77]
'SWj0msPqxr'	42544.40789	0	77	[75]
'9AdQdvK676'	42544.40794	1	103	[103 75]
'Qe88EHDxnu'	42544.40802	0	75	[103]
'sGUExvOOJf'	42544.40809	1	102	[102 103]
'RSserhYgkT'	42544.40809	1	79	[102 103 79]
'PGUDpKEfbt'	42544.40809	1	51	[102 103 51 79]
'XPEZ9B7GQf'	42544.40813	1	104	[102 103 104 51 79]
'PalS7WzJPV'	42544.40814	1	31	[102 103 104 31 51 79]
};


in_timestamps = cell2mat(data(find(cell2mat(data(:,3))==[1]),[2 4]));
%uniformaly sampling data
p = 1/86400;  % 1 second in a day
tstamps = cell2mat(data(:,2));
sampled = {};
for t = min(tstamps)+p:p:max(tstamps) + p
    tags = data(max(find (cell2mat(data(:,2))<t)),5);
    sampled(end+1,1:2) = [t tags];
end


trajectory = [];

 for n=1:length(sampled)
     t=cell2mat(sampled(n));
     coverage = cell2mat(sampled(n,2));
      coverage = transpose(intersect(coverage, beacons));
%       coverage = transpose(intersect (coverage,in_timestamps(:,2)))

     if size(coverage) > 0
            if numel(coverage) > 1
%     %           % Hierarchical filtering
                  X = beacons(ismember(beacons(:,1),transpose(coverage)), 1:3);
                  Y = pdist(X(:,2:3));
                  Z = linkage(Y);
                  T = cluster(Z,'maxclust',2);
                  if size(T(T==1)) >= size(T(T==2))
                      culster_id = 1;
                  else
                      culster_id = 2;
                  end
                  original_coverage = coverage;
                  coverage = transpose (intersect(X(T==culster_id), coverage))
%     %           % end filtering
            end
         
         
         last_in = [];
         for tag = coverage
             appeared_on = in_timestamps(max(find(in_timestamps(:,2)==tag & in_timestamps(:,1) <= t)));

             if isempty(appeared_on)
                 appeared_on = min(cell2mat(sampled(:,1)));
             end
             last_in(end+1,1) = appeared_on;
         end
    %      last_in= (last_in*1000) - min(last_in)
         if size(coverage) <=3
             last_in(:,1) = 1;
         else
                if range(last_in) == 0
                    last_in(:,1) = 1;
                else
                    last_in = last_in - min(last_in);
                    last_in = last_in/sum(last_in) * 100;
                end

         end
     
     
%          avg_x = mean (beacons(ismember(beacons(:,1),transpose(coverage)), 2));
%          avg_y = mean (beacons(ismember(beacons(:,1),transpose(coverage)), 3));
%          x(end+1) = avg_x;
%          y(end+1) = avg_y;

         wavg_x = sum (beacons(ismember(beacons(:,1),transpose(coverage)), 2) .* last_in)/sum(last_in);
          wavg_y = sum (beacons(ismember(beacons(:,1),transpose(coverage)), 3) .* last_in)/sum(last_in);
          trajectory(end+1,:) = [t, wavg_x, wavg_y];
          
     end
 end


% x=[];
% y=[];
% lookAhead = 2;
% for n=1:length(data)-lookAhead
%     coverage = cell2mat(data(n,5));
%     for l=1:lookAhead
%         coverage = intersect(coverage, cell2mat(data(n+l,5)));
%     end
%     if size(coverage)< 4
%         coverage = cell2mat(data(n,5));
%     end
%     if size(coverage) > 0
%         avg_x = mean(beacons(ismember(beacons(:,1),transpose(coverage)), 2));
%         avg_y = mean(beacons(ismember(beacons(:,1),transpose(coverage)), 3));
%         x(end+1) = avg_x;
%         y(end+1) = avg_y;
%     end
% end

x = trajectory(:,2);
y = trajectory(:,3);

Y= dct(y);Y1=Y;Y1(11:end)=0;y1 = idct(Y1);
X= dct(x);X1=X;X1(11:end)=0;x1 = idct(X1);
plot(x, y,'r','LineWidth',2);


        
legend('Ground Truth', 'Estimated Trajectory')