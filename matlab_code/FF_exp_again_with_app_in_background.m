XMin= 599435.5810000002;
YMin= 2358326.3035000004;
XMax= 599518.2827000003;
YMax= 2358386.9219000004;
[I,map] = imread('map_FF.png','png');
yImg = linspace(YMax, YMin, size(I, 1));
xImg = linspace(XMin, XMax, size(I, 2));
image(xImg, yImg, I, 'CDataMapping', 'scaled');
set(gca,'Ydir','normal');
hold on






beacons = [
%Minor  x       y           floor
1	599468.358	2358372.647	0
2	599471.1361	2358373.771	0
3	599466.1752	2358367.09	0
4	599475.4356	2358374.499	0
5	599478.5445	2358366.429	0
6	599470.144	2358361.402	0
7	599477.0231	2358357.962	0
8	599482.7117	2358356.838	0
9	599472.8559	2358352.075	0
10	599468.4903	2358353.597	0
11	599467.3658	2358348.437	0
12	599462.1403	2358351.017	0
13	599451.5569	2358347.18	0
14	599460.0236	2358344.204	0
15	599454.1366	2358341.227	0
16	599448.0512	2358346.056	0
17	599450.7632	2358339.971	0
18	599452.3507	2358336.134	0
19	599458.5023	2358330.512	0
20	599464.6538	2358356.044	0
21	599466.1752	2358362.857	0
22	599484.6299	2358366.76	0
23	599490.8476	2358363.188	0
24	599496.7346	2358359.748	0
25	599489.1278	2358359.087	0
26	599501.4971	2358365.437	0
27	599507.2518	2358362.328	0
28	599504.7383	2358357.764	0
30	599507.5164	2358351.083	0
31	599508.6409	2358358.624	1
32	599503.3492	2358363.717	1
33	599503.9445	2358368.215	1
34	599499.6451	2358364.643	1
35	599493.0305	2358363.254	1
36	599492.5013	2358359.153	1
37	599485.0929	2358362.791	1
38	599482.1825	2358356.044	1
39	599479.4044	2358363.452	1
40	599477.5523	2358354.523	1
41	599470.2762	2358354.126	1
42	599469.2179	2358349.892	1
43	599463.9924	2358346.254	1
44	599461.9419	2358351.149	1
45	599459.0976	2358343.675	1
46	599452.0861	2358347.114	1
47	599448.3158	2358345.527	1
48	599454.2028	2358341.426	1
49	599451.9538	2358337.457	1
50	599493.7581	2358356.242	1
51	599498.3221	2358354.39	1
52	599488.7971	2358358.822	1
53	599456.7163	2358349.099	1
54	599449.7048	2358342.352	1
55	599506.3258	2358364.246	1
56	599479.6028	2358360.211	1
57	599462.8679	2358359.417	1
58	599459.3622	2358357.698	1
71	599509.3685	2358356.904	0
72	599458.7007	2358349.694	0
75	599476.3613	2358371.568	1
76	599485.6218	2358374.876	1
77	599486.4155	2358375.405	1
78	599495.5437	2358378.712	1
79	599496.7343	2358379.374	1
80	599505.4656	2358382.946	1
90	599456.5175	2358363.896	1
91	599448.0509	2358359.662	1
92	599437.4675	2358355.561	1
93	599446.5956	2358359.133	1
94	599457.3113	2358330.161	1
95	599457.7082	2358333.733	1
96	599467.1009	2358337.173	1
97	599468.953	2358337.569	1
98	599476.0967	2358342.067	1
99	599477.6842	2358341.538	1
100	599486.0186	2358346.565	1
101	599487.6061	2358344.845	1
102	599495.8082	2358349.476	1
103	599499.777	2358347.888	1
104	599507.7145	2358350.402	1
];


data = {
%id  timestamp  event(1:in, 0:out) triggered_by  covered_by

'9mEJpLX8Vx'	42548.50374	1	96	[96]
'ahZGG3uCxs'	42548.50374	1	87	[87 96]
'lTxomxayY4'	42548.50375	1	90	[87 90 96]
'JdIig6t6l6'	42548.50375	1	97	[87 90 96 97]
'WHjebg3mWc'	42548.50375	1	95	[87 90 95 96 97]
'm4StoaiWs8'	42548.50376	1	98	[87 90 95 96 97 98]
'mWaPDCEWpl'	42548.50376	1	48	[48 87 90 95 96 97 98]
'abvAQMluuN'	42548.50377	1	84	[48 84 87 90 95 96 97 98]
'5VqeLONm4P'	42548.50377	1	82	[48 82 84 87 90 95 96 97 98]
'2RQvMxYUrN'	42548.50378	1	86	[48 82 84 86 87 90 95 96 97 98]
'ubCK7FJRUL'	42548.50378	1	89	[48 82 84 86 87 89 90 95 96 97 98]
'USOXc9kLD4'	42548.5038	1	83	[48 82 83 84 86 87 89 90 95 96 97 98]
'FMQjBstqz9'	42548.50381	1	81	[48 81 82 83 84 86 87 89 90 95 96 97 98]
'aQcYOz0oH3'	42548.50381	1	91	[48 81 82 83 84 86 87 89 90 91 95 96 97 98]
'57vPvjMFrD'	42548.50382	1	88	[48 81 82 83 84 86 87 88 89 90 91 95 96 97 98]
'f6G5KJd84e'	42548.50382	1	85	[48 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98]
'1w73pRSenA'	42548.50384	1	75	[48 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98]
'U362rDC7Lp'	42548.50385	1	99	[48 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'5boXP4a48o'	42548.50385	1	53	[48 53 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'kAiN6UA8NE'	42548.50386	1	58	[48 53 58 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'zWqKJfG24b'	42548.50386	1	44	[44 48 53 58 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'0CaX6tonmp'	42548.50387	1	45	[44 45 48 53 58 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'wrbRWJQjEN'	42548.50392	1	42	[42 44 45 48 53 58 75 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'lXt7eBGivE'	42548.50399	1	76	[42 44 45 48 53 58 75 76 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'ytGKmkSekz'	42548.50399	1	43	[42 43 44 45 48 53 58 75 76 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'cxXT3OxJuc'	42548.504	0	48	[42 43 44 45 53 58 75 76 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'7JvWaYeGB3'	42548.50401	0	58	[42 43 44 45 53 75 76 81 82 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'l4NU3tRjNs'	42548.50401	0	82	[42 43 44 45 53 75 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'MMj3CGfGwt'	42548.50407	1	101	[101 42 43 44 45 53 75 76 81 83 84 85 86 87 88 89 90 91 95 96 97 98 99]
'4BOLBSOhbf'	42548.50408	0	95	[101 42 43 44 45 53 75 76 81 83 84 85 86 87 88 89 90 91 96 97 98 99]
'bGtKghBmO1'	42548.50408	0	90	[101 42 43 44 45 53 75 76 81 83 84 85 86 87 88 89 91 96 97 98 99]
'mxmDgTJN3p'	42548.50409	0	99	[101 42 43 44 45 53 75 76 81 83 84 85 86 87 88 89 91 96 97 98]
'afcrMvDCnW'	42548.50409	0	42	[101 43 44 45 53 75 76 81 83 84 85 86 87 88 89 91 96 97 98]
'Ns1Iq7o78L'	42548.5041	0	75	[101 43 44 45 53 76 81 83 84 85 86 87 88 89 91 96 97 98]
'4uhsmqDawB'	42548.5041	0	44	[101 43 45 53 76 81 83 84 85 86 87 88 89 91 96 97 98]
'mEEmgdnUJq'	42548.50413	1	90	[101 43 45 53 76 81 83 84 85 86 87 88 89 90 91 96 97 98]
'DgDUJRXroQ'	42548.50414	1	75	[101 43 45 53 75 76 81 83 84 85 86 87 88 89 90 91 96 97 98]
'zREutlqCzS'	42548.50414	1	100	[100 101 43 45 53 75 76 81 83 84 85 86 87 88 89 90 91 96 97 98]
'gh2xetP3Ix'	42548.50415	0	97	[100 101 43 45 53 75 76 81 83 84 85 86 87 88 89 90 91 96 98]
'OGjyaAuUGY'	42548.50416	0	76	[100 101 43 45 53 75 81 83 84 85 86 87 88 89 90 91 96 98]
'BIdXc5euwI'	42548.50416	0	53	[100 101 43 45 75 81 83 84 85 86 87 88 89 90 91 96 98]
'cK2iRsVv8k'	42548.5042	1	103	[100 101 103 43 45 75 81 83 84 85 86 87 88 89 90 91 96 98]
'E7OcObiCPU'	42548.50421	1	56	[100 101 103 43 45 56 75 81 83 84 85 86 87 88 89 90 91 96 98]
'TdljP5JgRM'	42548.50422	0	101	[100 103 43 45 56 75 81 83 84 85 86 87 88 89 90 91 96 98]
'kJ689nzADF'	42548.50422	0	96	[100 103 43 45 56 75 81 83 84 85 86 87 88 89 90 91 98]
'4OulbGaZmR'	42548.50422	0	43	[100 103 45 56 75 81 83 84 85 86 87 88 89 90 91 98]
'IjW9IaaCA1'	42548.50423	0	45	[100 103 56 75 81 83 84 85 86 87 88 89 90 91 98]
'r3s4sGv8qD'	42548.50427	1	63	[100 103 56 63 75 81 83 84 85 86 87 88 89 90 91 98]
'g0TSy2Kzzn'	42548.50428	1	42	[100 103 42 56 63 75 81 83 84 85 86 87 88 89 90 91 98]
'kB9fbm9AEM'	42548.50428	1	41	[100 103 41 42 56 63 75 81 83 84 85 86 87 88 89 90 91 98]
'Vjd8lajvpW'	42548.50429	1	58	[100 103 41 42 56 58 63 75 81 83 84 85 86 87 88 89 90 91 98]
'bE00df3oLn'	42548.5043	1	96	[100 103 41 42 56 58 63 75 81 83 84 85 86 87 88 89 90 91 96 98]
'jxlQsoxuuR'	42548.5043	1	40	[100 103 40 41 42 56 58 63 75 81 83 84 85 86 87 88 89 90 91 96 98]
'diVibwtLUW'	42548.50431	0	89	[100 103 40 41 42 56 58 63 75 81 83 84 85 86 87 88 90 91 96 98]
'eWAaWG0gcm'	42548.50431	0	90	[100 103 40 41 42 56 58 63 75 81 83 84 85 86 87 88 91 96 98]
'uoGt2DOnsu'	42548.50432	0	81	[100 103 40 41 42 56 58 63 75 83 84 85 86 87 88 91 96 98]
'iBOQZnR2Mt'	42548.50432	0	83	[100 103 40 41 42 56 58 63 75 84 85 86 87 88 91 96 98]
'1e8At6WyCd'	42548.50432	0	87	[100 103 40 41 42 56 58 63 75 84 85 86 88 91 96 98]
'pizC5eRp88'	42548.50433	0	75	[100 103 40 41 42 56 58 63 84 85 86 88 91 96 98]
'9wuiUftWbf'	42548.50435	1	77	[100 103 40 41 42 56 58 63 77 84 85 86 88 91 96 98]
'gDf6dCmRON'	42548.50435	0	98	[100 103 40 41 42 56 58 63 77 84 85 86 88 91 96]
'tzgfHTfzJu'	42548.50436	0	103	[100 40 41 42 56 58 63 77 84 85 86 88 91 96]
'o6RE0VAIrN'	42548.50436	0	56	[100 40 41 42 58 63 77 84 85 86 88 91 96]
'8qJ1NLzHeQ'	42548.50442	0	88	[100 40 41 42 58 63 77 84 85 86 91 96]
'toR0el40jS'	42548.50443	0	63	[100 40 41 42 58 77 84 85 86 91 96]
'l4jlIZA12q'	42548.50444	0	40	[100 41 42 58 77 84 85 86 91 96]
't15pSBYkS4'	42548.50445	0	42	[100 41 58 77 84 85 86 91 96]
'YtEQz3L7WB'	42548.50445	0	96	[100 41 58 77 84 85 86 91]
'4BbwWFiPAy'	42548.50445	0	85	[100 41 58 77 84 86 91]
'HalQQ9Y5wR'	42548.50446	0	58	[100 41 77 84 86 91]
'ksF1JEA32f'	42548.50446	0	84	[100 41 77 86 91]
'Y0sqWZwOkW'	42548.50447	0	86	[100 41 77 91]
'wvm9kypQiq'	42548.50448	0	100	[41 77 91]
'k3OwCPKHtj'	42548.50449	0	41	[77 91]
'xgKs3EwMAT'	42548.5045	0	91	[77]
'mkM9ChTA9c'	42548.5045	0	77	[]
};


in_timestamps = cell2mat(data(find(cell2mat(data(:,3))==[1]),[2 4]));
%uniformaly sampling data
p = 1/86400;  % 1 second in a day
tstamps = cell2mat(data(:,2));
sampled = {};
for t = min(tstamps)+p:p:max(tstamps) + p
    tags = data(max(find (cell2mat(data(:,2))<t)),5);
    sampled(end+1,1:2) = [t tags];
end


trajectory = [];

 for n=1:length(sampled)
     t=cell2mat(sampled(n));
     coverage = cell2mat(sampled(n,2));
      ff = beacons(find(beacons(:,4)==1),:)
      coverage = transpose(intersect(coverage, ff));
%       coverage = transpose(intersect (coverage,in_timestamps(:,2)))

     if size(coverage) > 0
            if numel(coverage) > 1
%     %           % Hierarchical filtering
                  X = beacons(ismember(beacons(:,1),transpose(coverage)), 1:3);
                  Y = pdist(X(:,2:3));
                  Z = linkage(Y);
                  T = cluster(Z,'maxclust',2);
                  if size(T(T==1)) >= size(T(T==2))
                      culster_id = 1;
                  else
                      culster_id = 2;
                  end
                  original_coverage = coverage;
                  coverage = transpose (intersect(X(T==culster_id), coverage))
%     %           % end filtering
            end
         
         
         last_in = [];
         for tag = coverage
             appeared_on = in_timestamps(max(find(in_timestamps(:,2)==tag & in_timestamps(:,1) <= t)));

             if isempty(appeared_on)
                 appeared_on = min(cell2mat(sampled(:,1)));
             end
             last_in(end+1,1) = appeared_on;
         end
    %      last_in= (last_in*1000) - min(last_in)
         if size(coverage) <=3
             last_in(:,1) = 1;
         else
                if range(last_in) == 0
                    last_in(:,1) = 1;
                else
                    last_in = last_in - min(last_in);
                    last_in = last_in/sum(last_in) * 100;
                end

         end
     
     
%          avg_x = mean (beacons(ismember(beacons(:,1),transpose(coverage)), 2));
%          avg_y = mean (beacons(ismember(beacons(:,1),transpose(coverage)), 3));
%          x(end+1) = avg_x;
%          y(end+1) = avg_y;

         wavg_x = sum (beacons(ismember(beacons(:,1),transpose(coverage)), 2) .* last_in)/sum(last_in);
          wavg_y = sum (beacons(ismember(beacons(:,1),transpose(coverage)), 3) .* last_in)/sum(last_in);
          trajectory(end+1,:) = [t, wavg_x, wavg_y];
          
     end
 end


% x=[];
% y=[];
% lookAhead = 2;
% for n=1:length(data)-lookAhead
%     coverage = cell2mat(data(n,5));
%     for l=1:lookAhead
%         coverage = intersect(coverage, cell2mat(data(n+l,5)));
%     end
%     if size(coverage)< 4
%         coverage = cell2mat(data(n,5));
%     end
%     if size(coverage) > 0
%         avg_x = mean(beacons(ismember(beacons(:,1),transpose(coverage)), 2));
%         avg_y = mean(beacons(ismember(beacons(:,1),transpose(coverage)), 3));
%         x(end+1) = avg_x;
%         y(end+1) = avg_y;
%     end
% end

x = trajectory(:,2);
y = trajectory(:,3);

Y= dct(y);Y1=Y;Y1(10:end)=0;y1 = idct(Y1);
X= dct(x);X1=X;X1(10:end)=0;x1 = idct(X1);
plot(x1, y1,'r','LineWidth',2);


        
legend('Ground Truth', 'Estimated Trajectory')